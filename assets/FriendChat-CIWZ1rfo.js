import{_ as V,r as c,u as N,z as K,q as U,n as q,j as A,i as m,B as y,c as n,a as t,m as f,p as P,t as h,f as k,x as l,F as Y,s as j,w as z,v as E,C as H,b as C,d as G,h as J,o as a,e as F}from"./index-BN88ZBUW.js";import{_ as O}from"./bu_-IAMiqBfy.js";import{_ as Q,a as W}from"./emoji-K3bF6cTu.js";import{_ as X}from"./icons_outlined_addoutline-BzaaHx0t.js";import{u as Z}from"./messages-CyvoKFux.js";import{a as R,f as $}from"./formatChatTime-DR8uvMaV.js";const ee={class:"friend-chat"},te={class:"top-bar"},se={class:"title"},ae={key:0,class:"time"},ne={key:1,class:"message-me"},oe={class:"text-me"},re=["src"],ie={key:2,class:"message-target"},de=["src"],le={class:"text-target"},ue={key:0,class:"message-input"},ce=["onKeydown"],me={key:0,src:X,class:"input-icon"},_e={key:1,class:"bottem-placeholder-div"},B="http://localhost:3000",pe={__name:"FriendChat",setup(ve){const o=U(),T=G(),_=c([]),M=c(""),D=c(""),v=c(!0),d=c(""),w=N(),I=Z(),b=c(),u=K(()=>I.getMessagesByFriend(o.params.targetId));q(u,async()=>{if(!u.value[0])return;_.value.push({send_time:new Date,sender_id:u.value[0].senderId,content:u.value[0].content});const{message:r}=await m.post("/session/clear-unread",{sessionType:0,targetId:o.params.targetId});I.deleteMessage(u.value[0].senderId),await y(),g()},{immediate:!0}),A(async()=>{var p;const{messages:r}=await m.post("/private/messages",{userId2:o.params.targetId});_.value=r;const{users:e}=await m.post("/user/search",{query:o.params.targetId});M.value=e[0].username,D.value=e[0].avatar_url;const{isFriend:i}=await m.post("/isfriends",{friendId:o.params.targetId});v.value=i;const{message:s}=await m.post("/session/clear-unread",{sessionType:0,targetId:o.params.targetId});I.deleteMessage((p=u.value[0])==null?void 0:p.senderId),await y(),g(!1)});async function x(){if(d.value!=="")try{const{message:r}=await m.post("/private/send-message",{receiverId:o.params.targetId,messageType:0,content:d.value});_.value.push({send_time:new Date,sender_id:w.userInfo.user.id,content:d.value}),await y(),g({behavior:"smooth",block:"end",inline:"nearest"}),d.value=""}catch{window.alert("发送失败！")}}function S(r){const e=new Date(r),i=new Date;return e.getFullYear()===i.getFullYear()&&e.getMonth()===i.getMonth()&&e.getDate()===i.getDate()}function g(r){var e;(e=b.value)==null||e.scrollIntoView(r)}function L(){T.back()}return(r,e)=>{const i=J("RouterLink");return a(),n("div",ee,[t("div",te,[t("div",{class:"back-triangle",onClick:L}),t("div",se,h(M.value),1),v.value?(a(),P(i,{key:0,to:{name:"friendChatInfo",params:{targetId:l(o).params.targetId}}},{default:k(()=>e[1]||(e[1]=[t("img",{src:O,class:"info-icon"},null,-1)])),_:1},8,["to"])):f("",!0)]),e[4]||(e[4]=t("div",{class:"top-placeholder-div"},null,-1)),(a(!0),n(Y,null,j(_.value,(s,p)=>(a(),n("div",null,[p>0&&new Date(s.send_time)-new Date(_.value[p-1].send_time)>3*60*1e3?(a(),n("div",ae,h(S(s.send_time)?l(R)(s.send_time):l($)(s.send_time)+" "+l(R)(s.send_time)),1)):f("",!0),s.sender_id===l(w).userInfo.user.id?(a(),n("div",ne,[t("div",oe,h(s.content),1),F(i,{to:{name:"friendProfile",params:{targetId:s.sender_id}}},{default:k(()=>[t("img",{src:B+l(w).userInfo.user.avatar_url,class:"avatar"},null,8,re)]),_:2},1032,["to"])])):(a(),n("div",ie,[F(i,{to:{name:"friendProfile",params:{targetId:l(o).params.targetId}}},{default:k(()=>[t("img",{src:B+D.value,class:"avatar"},null,8,de)]),_:1},8,["to"]),t("div",le,h(s.content),1)]))]))),256)),v.value?(a(),n("div",ue,[e[2]||(e[2]=t("img",{src:Q,class:"input-icon",style:{height:"3.4em",width:"3.4em"}},null,-1)),z(t("textarea",{class:"text-input","onUpdate:modelValue":e[0]||(e[0]=s=>d.value=s),onFocus:g,onKeydown:H(C(x,["prevent"]),["enter"])},null,40,ce),[[E,d.value]]),e[3]||(e[3]=t("img",{src:W,class:"input-icon",style:{height:"3.4em",width:"3.4em"}},null,-1)),d.value===""?(a(),n("img",me)):(a(),n("button",{key:1,class:"send",onClick:C(x,["prevent"])},"发送"))])):f("",!0),v.value?(a(),n("div",_e)):f("",!0),t("div",{ref_key:"bottomRef",ref:b},null,512)])}}},ke=V(pe,[["__scopeId","data-v-6382ae79"]]);export{ke as default};
